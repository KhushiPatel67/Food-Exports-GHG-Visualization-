<!DOCTYPE html>
<html>
<style>
    .state {
        fill: lightgrey;
    }

    .outline {
        fill: none;
        stroke: black;
    }

    .title {
        font-size: 40px;
        border: 2px solid black;
    }

    .label {
        font-size: 20px;
        font-weight: bold;
    }

    .popup {
        position: absolute;
        top: 120px;
        right: 10px;
        padding: 10px;
        padding-top: 2px;
        padding-bottom: 50px;
        width: 350px;
        height: 50px;
        font-size: 18px;
        text-align: center;
    }
</style>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>

<body>
    <p class="title" style="text-align: center"> <strong>Agricultural GHG Emissions by State</strong></p>

    <input type="range" min="2011" max="2022" value="2011" id="yearSlider" style="width: 80%; margin: 20px;">
    <div id="yearDisplay" style="text-align: center; font-size: 20px;">Year: 2011</div>

    <svg id="map1" width="1500" height="700"></svg>

    <div id="popup" class="popup" style="border: 2px solid black; display: none;">
        <strong>Total Agricultural Emissions:
            <hr>
        </strong>
        <div id="popup-content"></div>
    </div>

    <script>
        let svg = d3.select("#map1");
        const width = svg.attr("width");
        const height = svg.attr("height");
        const margin = { top: 20, right: -10, bottom: 50, left: 410 };
        const mapWidth = width - margin.left - margin.right;
        const mapHeight = height - margin.top - margin.bottom;
        const map = svg.append("g");

        const requestData = async function () {
            const us = await d3.json("states.json");
            const emissionsData = await d3.csv("final_data/ag_ghg.csv", d3.autoType);

            console.log("Loaded States Data:", us);
            console.log("Loaded Emissions Data:", emissionsData);

            const colorScale = d3.scaleSequential(d3.interpolateOranges).domain([0, 38]);

            const states = topojson.feature(us, us.objects.states);
            var statesMesh = topojson.mesh(us, us.objects.states);
            const projection = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], states);
            const path = d3.geoPath().projection(projection);

            // Background rectangle for "no-hover" state
            map.append("rect")
                .attr("width", mapWidth)
                .attr("height", mapHeight)
                .attr("x", margin.left)
                .attr("y", margin.top)
                .style("fill", "transparent")
                .on("mouseover", function () {
                    const year = document.getElementById("yearSlider").value;
                    const totalEmissions = calculateTotalEmissions(year);
                    d3.select("#popup").style("display", "block");
                    d3.select("#popup-content").html(`Total: ${totalEmissions.toFixed(2)} MMT CO2e`);
                });

            const statePaths = map.selectAll("path.state").data(states.features)
                .join("path")
                .attr("class", "state")
                .attr("d", path)
                .style("fill", d => colorScale(getEmissionValue(d.properties.name, 2011))) // Initial color based on 2011
                .on("mouseover", function (event, d) {
                    const year = document.getElementById("yearSlider").value;
                    const emissionValue = getEmissionValue(d.properties.name, year);
                    console.log("Hovered on:", d.properties.name, "Emissions:", emissionValue);

                    d3.select(this).attr("stroke", "black").attr("stroke-width", 3.5);
                    d3.select("#popup").style("display", "block");
                    d3.select("#popup-content")
                        .html(`<strong>${d.properties.name}</strong><br>${emissionValue ? emissionValue.toFixed(2) + " MMT CO2e" : "No data"}`);
                })
                .on("mouseout", function () {
                    d3.select(this).attr("stroke-width", 1);
                    d3.select("#popup").style("display", "none");
                });

            map.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path);

            document.getElementById("yearSlider").addEventListener("input", function () {
                const year = this.value;
                document.getElementById("yearDisplay").textContent = `Year: ${year}`;
                updateMap(year);
            });

            function getEmissionValue(state, year) {
                const stateData = emissionsData.find(d => d.State === state && d.Year === +year);
                return stateData ? +stateData.Total_Ag_Emissions_In_MilsMecTon : 0;
            }

            function calculateTotalEmissions(year) {
                return emissionsData
                    .filter(d => d.Year === +year)
                    .reduce((sum, d) => sum + (d.Total_Ag_Emissions_In_MilsMecTon || 0), 0);
            }

            function updateMap(year) {
                console.log("Updating map for year:", year);

                statePaths.transition()
                    .duration(200)
                    .style("fill", d => {
                        const emissionValue = getEmissionValue(d.properties.name, year);
                        return emissionValue ? colorScale(emissionValue) : "#ccc"; // Default grey if no data
                    });
            }

            updateMap(2011);
        };

        requestData();
    </script>
</body>

</html>
