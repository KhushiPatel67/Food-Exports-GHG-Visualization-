<!DOCTYPE html>
<html>
<style>
    .state {
        fill: lightgrey;
    }

    .outline {
        fill: none;
        stroke: black;
    }

    .title {
        font-size: 40px;
        border: 2px solid black;
    }

    .label {
        font-size: 20px;
        font-weight: bold;
    }

    .popup {
        position: absolute;
        top: 120px;
        right: 10px;
        padding: 10px;
        padding-top: 2px;
        padding-bottom: 50px;
        width: 350px;
        height: 600px;
        font-size: 18px;
        text-align: center;
    }

    /* Styles for the pie chart */
    .pie-chart {
        width: 100%;
        height: 300px;
    }
</style>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>

<body>
    <p class="title" style="text-align: center"> <strong> Agricultural GHG Emissions by State </strong></p>

    <input type="range" min="2011" max="2022" value="2011" id="yearSlider" style="width: 80%; margin: 20px;">
    <div id="yearDisplay" style="text-align: center; font-size: 20px;">Year: 2011</div>

    <svg id="map1" width="1500" height="700"></svg>

    <div id="popup" class="popup" style="border: 2px solid black; display: none;">
        <strong>Total Agricultural Emissions:
            <hr>
        </strong>
        <div id="popup-content"></div>
        <svg id="pie-chart" class="pie-chart"></svg>
    </div>

    <script>
        // Ordered on priority:

        // 1) Visuals and functionality
        // For the pie chart in pop-up, add legend that displays colors and the 
        // numerical price of each export (update the data file to include that)
        // Move the slider to below the map and add a color scale legend for the
        // map itself (currently from 0 to >=38).

        // 2) New deafult state (no more blank pop-up)
        // By deafult, when no state is hovered over, it should show the 
        // summation of the emissions from all states and a pie chart of all 
        // total exports and their percentages. Should make another dataset for that.
        // Be sure that this pop-up does not bug out when moving between years.

        // 3) (only if we have time) New feature
        // When you click on a state, it "locks" the pop-up in to the state you 
        // clicked on (signified by a red outline instead of black).
        // Clicking the state again will "unlock" it and resume deafult behavior 
        // With this you can freely use the slider and watch the statitics in 
        // the box change.
        // This also means no other state will trigger a new box to be made while
        // as state is "locked".

        // Do not do this arrow key idea, this is just a feature I came up with.
        // Add a feature where pressing the arrow keys moves the slider by a year
        // if this is done, and your mouse is over a state, you should assume the
        // state hover over is considered "locked" and will seemlessly change to
        // the subsequent year when they are change this way.

        // same functio, run as deafault, make 

        let svg = d3.select("#map1");
        const width = svg.attr("width");
        const height = svg.attr("height");
        const margin = { top: 20, right: -10, bottom: 50, left: 410 };
        const mapWidth = width - margin.left - margin.right;
        const mapHeight = height - margin.top - margin.bottom;
        const map = svg.append("g");

        const requestData = async function () {
            const us = await d3.json("states.json");
            const emissionsData = await d3.csv("final_data/ag_ghg.csv", d3.autoType);
            const exportData = await d3.csv("final_data/food_exports.csv", d3.autoType);

            const colorScale = d3.scaleSequential(d3.interpolateOranges)
                .domain([0, 38]);

            const states = topojson.feature(us, us.objects.states);
            const statesMesh = topojson.mesh(us, us.objects.states);
            const projection = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], states);
            const path = d3.geoPath().projection(projection);

            const statePaths = map.selectAll("path.state").data(states.features)
                .join("path")
                .attr("class", "state")
                .attr("d", path)
                .style("fill", d => colorScale(getEmissionValue(d.properties.name, 2011)))  // Initial color based on 2011
                .on("mouseover", function (event, d) {
                    const year = document.getElementById("yearSlider").value;
                    const emissionValue = getEmissionValue(d.properties.name, year);

                    d3.select(this).attr("stroke", "black").attr("stroke-width", 3.5);
                    d3.select("#popup").style("display", "block");
                    d3.select("#popup-content")
                        .html(`<strong>${d.properties.name}</strong><br>${emissionValue ? emissionValue.toFixed(2) + " MMT CO2e" : "No data"}`);

                    drawPieChart(d.properties.name, +year);
                })
                .on("mouseout", function () {
                    d3.select(this).attr("stroke-width", 1);
                    d3.select("#popup").style("display", "none");
                });

            map.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path);

            document.getElementById("yearSlider").addEventListener("input", function () {
                const year = this.value;
                document.getElementById("yearDisplay").textContent = `Year: ${year}`;
                updateMap(year);
            });

            function getEmissionValue(state, year) {
                const stateData = emissionsData.find(d => d.State === state && d.Year === +year);
                return stateData ? +stateData.Total_Ag_Emissions_In_MilsMecTon : 0;
            }

            function updateMap(year) {
                statePaths.transition()
                    .duration(100)
                    .style("fill", d => {
                        const emissionValue = getEmissionValue(d.properties.name, year);
                        return emissionValue ? colorScale(emissionValue) : "#ccc";
                    });
            }

                    const legendWidth = 300;
                    const legendHeight = 10;

                    const legend = svg.append("g")
                        .attr("class", "legend")
                        .attr("transform", `translate(${margin.left + 20}, ${height - margin.bottom - 10})`);

                    const legendScale = d3.scaleLinear()
                        .domain(colorScale.domain())
                        .range([0, legendWidth]);

                    const legendAxis = d3.axisBottom(legendScale)
                        .ticks(6)
                        .tickFormat(d => `${d}%`);

                    legend.selectAll("rect")
                        .data(d3.ticks(...colorScale.domain(), 100))
                        .join("rect")
                        .attr("x", d => legendScale(d))
                        .attr("y", 0)
                        .attr("width", legendWidth /50)
                        .attr("height", legendHeight)
                        .attr("fill", d => colorScale(d));

                    legend.append("g")
                        .attr("transform", `translate(0, ${legendHeight})`)
                        .call(legendAxis);

                    legend.append("text")
                          .attr("x", legendWidth / 2)
                          .attr("y", legendHeight + 35) 
                          .attr("text-anchor", "middle")
                          .attr("fill", "black")
                          .text("Green House Gas Emissions");

            function drawPieChart(state, year) {
                const stateData = exportData.filter(d => d.State === state && d.Year === year);
                const pieData = stateData.map(d => ({
                    product: d.Product,
                    value: d.Export_percentage
                }));

                const radius = 100;
                const color = d3.scaleOrdinal(d3.schemeCategory10);
                const pie = d3.pie().value(d => d.value);
                const arc = d3.arc().innerRadius(0).outerRadius(radius);

                d3.select("#pie-chart").selectAll("*").remove();  // Clear previous pie chart
                const g = d3.select("#pie-chart")
                    .attr("width", radius * 2)
                    .attr("height", radius * 2)
                    .append("g")
                    .attr("transform", `translate(${radius}, ${radius})`);

                g.selectAll("path")
                    .data(pie(pieData))
                    .join("path")
                    .attr("d", arc)
                    .attr("fill", d => color(d.data.product));

                g.selectAll("text")
                    .data(pie(pieData))
                    .join("text")
                    .attr("transform", d => `translate(${arc.centroid(d)})`)
                    .attr("dy", "0.35em")
                    .attr("font-size", "10px")
                    .text(d => d.data.product);
            }

            updateMap(2011);
        };

        requestData();
    </script>
</body>

</html>